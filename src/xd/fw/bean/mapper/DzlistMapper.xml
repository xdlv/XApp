<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="xd.fw.bean.mapper.DzlistMapper">
    <resultMap id="DzlistResultMap" type="xd.fw.bean.Dzlist">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <result column="year" jdbcType="INTEGER" property="year"/>
        <result column="month" jdbcType="INTEGER" property="month"/>
        <result column="impdate" jdbcType="DATE" property="impdate"/>
        <result column="userid" jdbcType="VARCHAR" property="userid"/>
        <result column="Username" jdbcType="VARCHAR" property="username"/>
        <result column="Isok" jdbcType="CHAR" property="isok"/>
        <result column="Qmye" jdbcType="REAL" property="qmye"/>
        <result column="zdxsk1" jdbcType="REAL" property="zdxsk1"/>
        <result column="ysdsk1" jdbcType="REAL" property="ysdsk1"/>
        <result column="zdfwk1" jdbcType="REAL" property="zdfwk1"/>
        <result column="jb1" jdbcType="REAL" property="jb1"/>
        <result column="fl1" jdbcType="REAL" property="fl1"/>
        <result column="zdxsk2" jdbcType="REAL" property="zdxsk2"/>
        <result column="jb2" jdbcType="REAL" property="jb2"/>
        <result column="fl2" jdbcType="REAL" property="fl2"/>
        <result column="zdfwk2" jdbcType="REAL" property="zdfwk2"/>
        <result column="qtyfdk2" jdbcType="REAL" property="qtyfdk2"/>
        <result column="credit_scope" jdbcType="VARCHAR" property="creditScope"/>
    </resultMap>
    <insert id="insert" parameterType="xd.fw.bean.Dzlist">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into t_dzlist (year, month, impdate,
        userid, Username, Isok,
        Qmye, zdxsk1, ysdsk1, zdfwk1,
        jb1, fl1, zdxsk2, jb2,
        fl2, zdfwk2, qtyfdk2, credit_scope
        )
        values (#{year,jdbcType=INTEGER}, #{month,jdbcType=INTEGER}, #{impdate,jdbcType=DATE},
        #{userid,jdbcType=VARCHAR}, #{username,jdbcType=VARCHAR}, #{isok,jdbcType=CHAR},
        #{qmye,jdbcType=REAL}, #{zdxsk1,jdbcType=REAL}, #{ysdsk1,jdbcType=REAL}, #{zdfwk1,jdbcType=REAL},
        #{jb1,jdbcType=REAL}, #{fl1,jdbcType=REAL}, #{zdxsk2,jdbcType=REAL}, #{jb2,jdbcType=REAL},
        #{fl2,jdbcType=REAL}, #{zdfwk2,jdbcType=REAL}, #{qtyfdk2,jdbcType=REAL}, #{creditScope,jdbcType=VARCHAR}
        )
    </insert>


    <select id="getDzListCount" parameterType="xd.fw.bean.Dzlist" resultType="java.lang.Integer">
        SELECT count(*) FROM t_dzlist a LEFT JOIN t_user_company b ON a.userid = b.code WHERE 1 =1
        <if test="phone != null">
            and (b.wx_contract_phone1 =#{phone,jdbcType=VARCHAR} OR b.wx_contract_phone2 =#{phone,jdbcType=VARCHAR})
        </if>
        <if test="userid != null">and userid=#{userid,jdbcType=VARCHAR}</if>
        <if test="isQueryOk != null">
            and isok in
            <foreach item="item" index="index" collection="isQueryOk" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="username != null">and username like '%${username}%'</if>
        <if test="year != null">and year =#{year,jdbcType=INTEGER}</if>
        <if test="month != null">and month =#{month,jdbcType=INTEGER}</if>
    </select>

    <select id="selectDzlists" parameterType="java.lang.String" resultMap="DzlistResultMap">

        SELECT a.* FROM t_dzlist a LEFT JOIN t_user_company b ON (a.userid = b.code and a.credit_scope=b.credit_scope) WHERE 1 =1
        <if test="dzlist.phone != null">
            and (b.wx_contract_phone1 =#{dzlist.phone,jdbcType=VARCHAR} OR b.wx_contract_phone2
            =#{dzlist.phone,jdbcType=VARCHAR})
        </if>
        <if test="dzlist.userid != null">and userid=#{dzlist.userid,jdbcType=VARCHAR}</if>
        <if test="dzlist.isQueryOk != null">
            and isok in
            <foreach item="item" index="index" collection="dzlist.isQueryOk" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="dzlist.username != null">and username like '%${dzlist.username}%'</if>
        <if test="dzlist.year != null">and year =#{dzlist.year,jdbcType=INTEGER}</if>
        <if test="dzlist.month != null">and month =#{dzlist.month,jdbcType=INTEGER}</if>
        limit #{start,jdbcType=INTEGER} , #{limit,jdbcType=INTEGER}
    </select>

    <select id="selectDzlists" parameterType="java.lang.String" resultMap="DzlistResultMap" databaseId="oracle">
        SELECT * FROM (SELECT A.*, ROWNUM RN FROM (SELECT a.* FROM t_dzlist a LEFT JOIN t_user_company b
        ON (a.userid = b.code and a.credit_scope=b.credit_scope) WHERE 1=1
        <if test="dzlist.phone != null">
            and (b.wx_contract_phone1 =#{dzlist.phone,jdbcType=VARCHAR} OR b.wx_contract_phone2
            =#{dzlist.phone,jdbcType=VARCHAR})
        </if>
        <if test="dzlist.userid != null">and userid=#{dzlist.userid,jdbcType=VARCHAR}</if>
        <if test="dzlist.isQueryOk != null">
            and isok in
            <foreach item="item" index="index" collection="dzlist.isQueryOk" open="(" separator="," close=")">
            #{item}
            </foreach>
        </if>
        <if test="dzlist.year != null">and year =#{dzlist.year,jdbcType=INTEGER}</if>
        <if test="dzlist.month != null">and month =#{dzlist.month,jdbcType=INTEGER}</if>
        <if test="dzlist.username != null">and username like '%${dzlist.username}%'</if>)
        A WHERE ROWNUM &lt;= ${start} + ${limit} ) WHERE RN &gt; #{start,jdbcType=INTEGER}
    </select>

    <select id="selectDzlistsByYearAndMonth" parameterType="java.lang.String" resultMap="DzlistResultMap">
    select c.*,a.wxid,b.wx_contract_phone1,b.wx_contract_phone2 from t_userdz a JOIN t_user_company b
    on (a.phone = b.wx_contract_phone1 or a.phone = b.wx_contract_phone2)
  JOIN t_dzlist c on (b.code = c.userid and b.credit_scope=c.credit_scope) where
   c.year=#{year,jdbcType=INTEGER} and c.month=#{month,jdbcType=INTEGER} <if test="wxid != null">and a.wxid=#{wxid, jdbcType=VARCHAR}</if>
  </select>

    <update id="updateDzlistStatus" parameterType="xd.fw.bean.Dzlist">
        update t_dzlist set isok=#{isok,jdbcType=CHAR} where year=#{year,jdbcType=INTEGER}
        and month=#{month,jdbcType=INTEGER} and userid=#{userid,jdbcType=VARCHAR}
        and credit_scope=#{creditScope,jdbcType=VARCHAR}
    </update>

    <update id="updateDzListAutomatic" parameterType="java.lang.Integer">
        <!-- 5 day = 43200 seconds-->
        update t_dzList set isok='A' where impdate + 43200 &lt; now()
    </update>
    <update id="updateDzListAutomatic" parameterType="java.lang.Integer" databaseId="oracle">
        <!-- 5 day-->
        update t_dzList set isok='A' where impdate &lt; (sysdate - interval '5' DAY)
    </update>

    <delete id="deleteDzlistForImport" parameterType="xd.fw.bean.Dzlist">
    delete from t_dzlist where year=#{year,jdbcType=INTEGER}
    and month=#{month,jdbcType=INTEGER} and userid=#{userid,jdbcType=VARCHAR}
    and credit_scope = #{creditScope,jdbcType=VARCHAR}
  </delete>

    <delete id="deleteDzlitByYearAndMonth" parameterType="java.lang.Integer">
         delete from t_dzlist where year=#{year,jdbcType=INTEGER} and month=#{month,jdbcType=INTEGER}
    </delete>


    <select id="selectAllDzlisWithUser" parameterType="java.lang.Integer" resultMap="DzlistResultWithUserdzMap">
        SELECT a.*,b.wx_contract_phone1,b.wx_contract_phone2,c.wxid FROM t_dzlist a LEFT JOIN t_user_company b ON a.userid=b.code LEFT JOIN t_userdz c
   ON (b.wx_contract_phone1=c.phone OR b.wx_contract_phone2=c.phone ) where  a.year=#{year,jdbcType=INTEGER} and a.month=#{month,jdbcType=INTEGER}
    </select>

    <resultMap id="DzlistResultWithUserdzMap" type="xd.fw.bean.Dzlist" extends="DzlistResultMap">
        <association property="userdz" javaType="xd.fw.bean.Userdz">
        <result property="wxid" column="wxid"/>
    </association>
        <association property="userCompany" javaType="xd.fw.bean.UserCompany">
            <result property="wxContractPhone1" column="wx_contract_phone1"/>
            <result property="wxContractPhone2" column="wx_contract_phone2"/>
        </association>
    </resultMap>

</mapper>